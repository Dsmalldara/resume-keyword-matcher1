generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Profile {
  id              String           @id @db.Uuid
  userId          String           @unique @db.Uuid
  username        String?
  displayName     String?
  bio             String?
  avatarUrl       String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  email           String           @unique
  deletedAt       DateTime?
  storageKey      String           @unique @default(uuid())
  ActivityLog     ActivityLog[]
  analyses        Analysis[]
  coverLetters    CoverLetter[]
  jobDescriptions JobDescription[]
  resumes         Resume[]
  usageQuota      UsageQuota?

  @@index([email])
  @@index([deletedAt])
  @@map("profiles")
}

model UsageQuota {
  id                  String           @id @default(cuid())
  profileId           String           @unique @db.Uuid
  tier                SubscriptionTier @default(FREE)
  resumesUsed         Int              @default(0)
  resumesLimit        Int              @default(3)
  analysesUsed        Int              @default(0)
  analysesLimit       Int              @default(5)
  analysesResetAt     DateTime         @default(now())
  coverLettersUsed    Int              @default(0)
  coverLettersLimit   Int              @default(5)
  coverLettersResetAt DateTime         @default(now())
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  profile             Profile          @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("usage_quotas")
}

model Resume {
  id           String          @id @default(cuid())
  name         String
  fileUrl      String
  createdAt    DateTime        @default(now())
  deletedAt    DateTime?
  isActive     Boolean         @default(true)
  profileId    String          @db.Uuid
  updatedAt    DateTime        @updatedAt
  version      Int             @default(1)
  fileSize     BigInt
  storageKey   String
  status       String          @default("pending")
  analyses     Analysis[]
  coverLetters CoverLetter[]
  versions     ResumeVersion[]
  profile      Profile         @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, deletedAt])
  @@index([profileId, isActive])
  @@map("resumes")
  ResumeContent ResumeContent[]
}

model ResumeVersion {
  id        String   @id @default(cuid())
  resumeId  String
  version   Int
  name      String
  fileUrl   String
  createdAt DateTime @default(now())
  createdBy String   @db.Uuid
  resume    Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@unique([resumeId, version])
  @@index([resumeId])
  @@map("resume_versions")
}

model ResumeContent {
  id            String   @id @default(cuid())
  resumeId      String
  candidateName String?
  email         String?
  phone         String?
  skills        Json?    
  experiences   Json?
  education     Json?
  certifications Json?
  rawText       String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  projects      Json?

  resume        Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([resumeId])
  @@map("resume_contents")
}
model JobDescription {
  id           String        @id @default(cuid())
  title        String
  company      String?
  description  String
  dateAdded    DateTime      @default(now())
  deletedAt    DateTime?
  confidenceScore Float?
  profileId    String        @db.Uuid
  updatedAt    DateTime      @updatedAt
  status       JobStatus     @default(PENDING)
  analyses     Analysis[]
  coverLetters CoverLetter[]
  profile      Profile       @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, deletedAt])
  @@index([profileId, status])
  @@map("job_descriptions")
}
  
model Analysis {
  id           String         @id @default(cuid())
  resumeId     String
  resumeName   String
  jobId        String
  jobTitle     String?
  jobCompany   String?
  matchScore   Int
  summary      String
  strengths    String[]
  gaps         String[]
  nextSteps    String
  dateAnalyzed DateTime       @default(now())
  deletedAt    DateTime?
  profileId    String         @db.Uuid
  updatedAt    DateTime       @updatedAt
  createdAt    DateTime       @default(now())
  status       AnalysisStatus @default(PENDING)
  job          JobDescription @relation(fields: [jobId], references: [id], onDelete: Cascade)
  profile      Profile        @relation(fields: [profileId], references: [id], onDelete: Cascade)
  resume       Resume         @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  coverLetters CoverLetter[]

  @@index([profileId, deletedAt])
  @@index([resumeId])
  @@index([jobId])
  @@index([status])
  @@map("analyses")
}

model CoverLetter {
  id            String               @id @default(cuid())
  resumeId      String
  jobId         String
  analysisId    String
  dateGenerated DateTime             @default(now())
  preview       String
  fullText      String
  customNotes   String?
  deletedAt     DateTime?
  profileId     String               @db.Uuid
  updatedAt     DateTime             @updatedAt
  version       Int                  @default(1)
  status        CoverLetterStatus    @default(DRAFT)
  versions      CoverLetterVersion[] 
  analysis      Analysis             @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  job           JobDescription       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  profile       Profile              @relation(fields: [profileId], references: [id], onDelete: Cascade)
  resume        Resume               @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([profileId, deletedAt])
  @@index([resumeId])
  @@index([jobId])
  @@index([status])
  @@map("cover_letters")
}

model CoverLetterVersion {
  id            String      @id @default(cuid())
  coverLetterId String
  version       Int
  fullText      String
  customNotes   String?
  createdAt     DateTime    @default(now())
  createdBy     String      @db.Uuid
  coverLetter   CoverLetter @relation(fields: [coverLetterId], references: [id], onDelete: Cascade)

  @@unique([coverLetterId, version])
  @@index([coverLetterId])
  @@map("cover_letter_versions")
}

model ActivityLog {
  id         String       @id @default(cuid())
  entityId   String
  entityType String
  message    String
  createdAt  DateTime     @default(now())
  metadata   Json?
  profileId  String       @db.Uuid
  type       ActivityType
  profile    Profile      @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, createdAt])
  @@index([type])
  @@map("activity_logs")
}

enum JobStatus {
  PENDING
  ACTIVE
  ARCHIVED
  DELETED
}

enum AnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ActivityType {
  RESUME_UPLOAD
  RESUME_UPDATE
  RESUME_DELETE
  JOB_ADD
  JOB_UPDATE
  JOB_DELETE
  ANALYSIS_CREATE
  ANALYSIS_COMPLETE
  COVER_LETTER_GENERATE
  COVER_LETTER_UPDATE
}

enum CoverLetterStatus {
  DRAFT
  COMPLETED
  ARCHIVED
}

enum SubscriptionTier {
  FREE
  PRO
  ENTERPRISE
}
